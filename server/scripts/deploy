#!/usr/bin/env bash

set -e

target="aarch64-unknown-linux-gnu"
host="pi@192.168.1.5"
dest="/home/pi/inkarta"
binary="inkarta"

# Cross-compile to Raspberry Pi (64-bit) if binary doesn't exist
if [ ! -f "target/$target/release/$binary" ]; then
    cross build --release --target $target
fi

echo "Deploying to $host..."

# Stop the server
ssh "$host" "sudo systemctl stop $binary || true"

# Copy files
ssh "$host" "mkdir -p $dest"
rsync "target/$target/release/$binary" "$host:$dest/"
rsync -av deploy/ "$host:$dest/"

# Restart the server
ssh "$host" "sudo systemctl daemon-reload && sudo systemctl start $binary"

echo "Deployment complete."
